{% extends 'base.html' %}
{% load static %}
{% block Company_Assemblies_active %}active open{% endblock %}
{% block Estimate_Assemblies_active %}active{% endblock %}
{% block content %}


<style>
  .dropdown-menu {
      max-height: 200px;
      overflow-y: auto;
  }
</style>



<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Assemblies /</span> Edit Estimate Assemblies</h4>

    <div class="row">
      <div class="col-md-12">
        
        <div class="card mb-4">
          <h5 class="card-header">Edit Estimate Assemblies</h5>
          
          <hr class="my-0">
          <div class="card-body">
            <!-- <div class="row mb-3">
              <div class="col-sm-4">
                <div class="input-group input-group-merge">
                    <span class="input-group-text">Choose Resource</span>
                    <select  class="form-select">
                        <option value="" disabled selected>Select a resource</option>
                        {% for resource in filter_resources %}
                            <option 
                                value="{{ resource.id }}" 
                                data-name="{{ resource.Resource_Name }}" 
                                data-price="{{ resource.Budget_Unit_Cost }}" 
                                data-code-l1="{{ resource.Resource_Code_L1.Resource_Code_L1 }}"
                                data-code-l2="{{ resource.Resource_Code_L2.Resource_Code_L2 }}"
                                data-code-l3="{{ resource.Resource_Code_L3.Resource_Code_L3 }}"
                                data-unit="{{ resource.Unit_of_Measure }}">
                                {{ resource.Resource_Code_L3.Resource_Code_L3 }} ({{ resource.Unit_of_Measure }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
  
                  <div class="input-group mb-3">
                      <input type="text" class="form-control"  id="numberInput" placeholder="Resource">
                      <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton">
                          <span class="visually-hidden">Toggle Dropdown</span>
                      </button>
                      <ul class="dropdown-menu w-100" id="dropdownMenu" style="margin-top: 42px;"></ul>
                  </div>
               </div>
            
              
              <div class="col-sm-3">
                <div class="input-group">
                    <span class="input-group-text">Resource Quantity</span>
                    <input type="number" id="resourceQuantity" class="form-control" placeholder="Resource Quantity" value="1.00" step="0.01" min="0">
                </div>
              </div>

              <div class="col-sm-3">
                <div class="input-group">
                    <span class="input-group-text">Assembly Quantity</span>
                    <input type="number" id="assemblyQuantity" class="form-control" placeholder="Assembly Quantity" value="1.00" step="0.01" min="0">
                </div>
              </div>
            
              
              <div class="col-sm-2 d-flex align-items-center" style="margin-top: -15px;">
                  <button type="button" class="btn btn-warning w-100" onclick="addItem()">Add +</button>
              </div>
          </div> -->


          <div class="row mb-3">
            <div class="col-sm-5">
              <div class="input-group">
                  <span class="input-group-text">Assembly Quantity</span>
                  <input type="number" id="assemblyQuantity" class="form-control" placeholder="Assembly Quantity" value="{% if get_assembly_record.Assembly_Quantity %}{{get_assembly_record.Assembly_Quantity}}{% else %}1.00{% endif %}" step="0.01" min="0" >
              </div>
            </div>
            <div class="col-sm-4">
                  <!-- <label for="Unit" class="form-label">Unit of Measure</label> -->
                  <input type="text" id="Unit_of_Measure" name="Unit_of_Measure" class="form-control" placeholder="Unit of Measure"  value="{{get_assembly_record.Unit_of_Measure}}">
              </div>

              <div class="col-sm-3 d-flex align-items-center" style="">
                <button type="button" class="btn btn-warning w-100" onclick="Next_Option()">Next ></button>
            </div>
            
        </div>

        <div  id="second_section_id" style="display: none;">
            <div class="row mb-3">
            
            <div class="col-md-5">
                <!-- <div class="input-group input-group-merge">
                    <span class="input-group-text">Choose Resource</span>
                    <select  class="form-select">
                        <option value="" disabled selected>Select a resource</option>
                        {% for resource in filter_resources %}
                            <option 
                                value="{{ resource.id }}" 
                                data-name="{{ resource.Resource_Name }}" 
                                data-price="{{ resource.Budget_Unit_Cost }}" 
                                data-code-l1="{{ resource.Resource_Code_L1.Resource_Code_L1 }}"
                                data-code-l2="{{ resource.Resource_Code_L2.Resource_Code_L2 }}"
                                data-code-l3="{{ resource.Resource_Code_L3.Resource_Code_L3 }}"
                                data-unit="{{ resource.Unit_of_Measure }}">
                                {{ resource.Resource_Code_L3.Resource_Code_L3 }} ({{ resource.Unit_of_Measure }})
                            </option>
                        {% endfor %}
                    </select>
                </div> -->

                <div class="input-group mb-4">
                    <input type="text" class="form-control"  id="numberInput" placeholder="Resource">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <ul class="dropdown-menu w-100" id="dropdownMenu" style="margin-top: 42px;"></ul>
                </div>
            </div>
            
            
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">Resource Quantity</span>
                    <input type="number" id="resourceQuantity" class="form-control" placeholder="Resource Quantity" value="1.00" step="0.01" min="0">
                </div>
            </div>

            
            
            
            <div class="col-md-3 d-flex align-items-center" style="margin-top: -24px;">
                <button type="button" class="btn btn-warning w-100" onclick="addItem()">Add +</button>
            </div>
            </div>
        </div>
          
          <script>
              const numberInput = document.getElementById('numberInput');
              const dropdownMenuButton = document.getElementById('dropdownMenuButton');
              const dropdownMenu = document.getElementById('dropdownMenu');
          
              // Parse the JSON data containing all four columns
              let data = JSON.parse('{{ filter_resources_json|safe }}');
              console.log(data);
          
              function populateDropdown(items) {
                  dropdownMenu.innerHTML = ''; // Clear existing items
                  console.log(items.length)
                  console.log('items')
                  if (items.length == 0){
                    dropdownMenu.innerHTML = 'No Resource To Select!';
                  }
                  items.forEach(item => {
                      const li = document.createElement('li');
                      
                      // Display the Resource Code L3 and Unit of Measure in the dropdown
                      const resourceCode = item.Resource_Title || `Resource Code L3 ID: ${item.Resource_Code_L3_id}`;
                      const unitOfMeasure = item.Unit_of_Measure || 'No unit'; // Default to 'No unit' if missing

                      // Create the anchor tag for each item
                      const aTag = document.createElement('a');
                      aTag.classList.add('dropdown-item');
                      aTag.href = "#"; // Ensure href is set to a safe value
                      
                      // Set the inner text for the anchor tag
                      aTag.innerHTML = `${resourceCode} (${unitOfMeasure})`;
                      
                      // Add data attributes to the anchor tag
                      aTag.setAttribute('data-name', item.Resource_Title);
                      aTag.setAttribute('data-price', item.Budget_Unit_Cost);
                      aTag.setAttribute('data-code-l1', item.Resource_Code_L1__Resource_Code_L1);
                      aTag.setAttribute('data-code-l2', item.Resource_Code_L2__Resource_Code_L2);
                      aTag.setAttribute('data-code-l3', item.Resource_Code_L3__Resource_Code_L3);
                      aTag.setAttribute('data-unit', item.Unit_of_Measure);

                      // Add the click event listener for the anchor tag
                      aTag.addEventListener('click', (e) => {
                          e.preventDefault(); // Prevent the default anchor behavior
                          
                          // Set the input field values based on the selected item
                          numberInput.value = item.Resource_Title; // Assuming you want to use item.id for input value

                          // Optionally, you can also set data attributes on numberInput if needed
                          numberInput.setAttribute('data-name', item.Resource_Title);
                          numberInput.setAttribute('data-price', item.Budget_Unit_Cost);
                          numberInput.setAttribute('data-code-l1', item.Resource_Code_L1__Resource_Code_L1);
                          numberInput.setAttribute('data-code-l2', item.Resource_Code_L2__Resource_Code_L2);
                          numberInput.setAttribute('data-code-l3', item.Resource_Code_L3__Resource_Code_L3);
                          numberInput.setAttribute('data-code-l4', item.id);
                          numberInput.setAttribute('data-unit', item.Unit_of_Measure);

                          // Hide the dropdown and redirect (if needed)
                          dropdownMenu.classList.remove('show');
                          // window.location.href = ``; // Redirect to the new page
                      });

                      // Append the anchor tag to the list item and the list item to the dropdown menu
                      li.appendChild(aTag);
                      dropdownMenu.appendChild(li);
                  });
              }

          
              // Initially populate the dropdown with all data
              populateDropdown(data);
          
              // Toggle dropdown visibility
              dropdownMenuButton.addEventListener('click', () => {
                  dropdownMenu.classList.toggle('show'); // Toggle dropdown visibility
              });
          
              // Filter dropdown based on input
              numberInput.addEventListener('input', () => {
                  const value = numberInput.value;
                  const filteredData = data.filter(item => item.Resource_Code_L3__Resource_Code_L3.toString().startsWith(value));
                  populateDropdown(filteredData); // Update dropdown with filtered data
                  dropdownMenu.classList.add('show'); // Show the dropdown
              });
          
              // Close dropdown when clicking outside
              document.addEventListener('click', (e) => {
                  if (!dropdownMenuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                      dropdownMenu.classList.remove('show'); // Hide the dropdown
                  }
              });
          </script>
            <!-- Resource Selection and Quantity Input -->
            
          
          <table id="resourceTable" class="table table-bordered">
              <thead>
                <tr>
                  <th>Resource Name</th>
                  <th>Resource Code L1</th>
                  <th>Resource Code L2</th>
                  <th>Resource Code L3</th>
                  <th>Resource Quantity</th>
                  <th>Assembly Quantity</th>
                  <th>Quantity</th>
                  <th>Unit Cost</th>
                  <th>Total Cost</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="resourceTableBody">
                {% for exist_resource in filter_Estimation_Assemblies_Resource_Details %}
                <tr>
                  <td>{{ exist_resource.Resource_record.Resource_Title }}</td>
                  <td>{{ exist_resource.Resource_record.Resource_Code_L1.Resource_Code_L1 }}</td>
                  <td>{{ exist_resource.Resource_record.Resource_Code_L2.Resource_Code_L2 }}</td>
                  <td>{{ exist_resource.Resource_record.Resource_Code_L3.Resource_Code_L3 }}</td>
                  <td>{{ exist_resource.Resource_Quantity }} </td>
                  <td>{{ exist_resource.Assembly_Quantity }} </td>
                  <td>{{ exist_resource.Quantity }} {{ exist_resource.Unit_of_Measure }}</td>
                  <td>${{ exist_resource.Resource_Budget_Unit_Cost }}</td>
                  <td class="row-total">${{ exist_resource.Unit_Cost }}</td>
                  <td>
                    <button type="button" class="btn btn-danger btn-sm delete-row" data-id="{{ exist_resource.id}}">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="8" style="text-align: right;"><strong>Total Cost:</strong></td>
                  <td colspan="1">$<span id="totalCost">0.00</span></td>
                  <td colspan="1"></td>
                </tr>
              </tfoot>
            </table>



          <!-- Button to submit or process the resources -->
          <div class="text-center mt-3" id="div_save_button" style="display: block;">
            
            <div class="mt-3">
              <!-- Button trigger modal -->
              <button type="button" class="btn btn-primary" onclick="modal_open_func()" data-bs-toggle="modal" data-bs-target="#modalCenter">
                Save Assembly
              </button>

              <!-- Modal -->
              <div class="modal fade" id="modalCenter" tabindex="-1" style="display: none;" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <form method="POST" action="{% url 'save_edit_company_assembly_record' %}"> {% csrf_token %}
                      <input type="hidden" name="list_resourses_ids" id="list_resourses_ids">
                      <input type="hidden" name="get_assembly_record_id" value="{{get_assembly_record.id}}">

                      <div class="modal-header">
                        <h5 class="modal-title" id="modalCenterTitle">Company Assembly</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">

                        <div class="row g-2">
                            <div class="col mb-0">
                              <label for="Assembly_Title" class="form-label">Assembly Name</label>
                              <input type="text" id="Assembly_Title" class="form-control" name="Assembly_Title" value="{{get_assembly_record.Assembly_Title}}" placeholder="Assembly Name" required>
                            </div>
                        </div>

                        <div class="row g-2 mt-3">
                            <div class="mb-3 col-md-4">
                              <label for="Assemblies_Code_L1" class="form-label">Assemblies Code L1</label>
                              <select class="form-select" id="Assemblies_Code_L1" name="Assemblies_Code_L1" required>
<!--                                  <option value="">&#45;&#45; Select &#45;&#45;</option>-->
                                  {% if get_assembly_record %}
                                  <option value="{{ get_assembly_record.Assemblies_Code_L1.id }}">{{ get_assembly_record.Assemblies_Code_L1.Assemblies_Code_L1 }}</option>
                                  {% endif %}
                                  {% for company_Assemblies_Code_L1 in filter_company_Assemblies_Code_L1_query %}
                                  <option value="{{ company_Assemblies_Code_L1.id }}">{{ company_Assemblies_Code_L1.Assemblies_Code_L1 }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                          <div class="mb-3 col-md-4">
                              <label for="Assemblies_Code_L2" class="form-label">Assemblies Code L2</label>
                              <select class="form-select" id="Assemblies_Code_L2" name="Assemblies_Code_L2" required disabled>
<!--                                  <option value="">&#45;&#45; Select &#45;&#45;</option>-->
                                  {% if get_assembly_record %}
                                  <option value="{{ get_assembly_record.Assemblies_Code_L2.id }}">{{ get_assembly_record.Assemblies_Code_L2.Assemblies_Code_L2 }}</option>
                                  {% endif %}
                              </select>
                          </div>
                          <div class="mb-3 col-md-4">
                              <label for="Assemblies_Code_L3" class="form-label">Assemblies Code L3</label>
                              <select class="form-select" id="Assemblies_Code_L3" name="Assemblies_Code_L3" required disabled>
<!--                                  <option value="">&#45;&#45; Select &#45;&#45;</option>-->
                                  {% if get_assembly_record %}
                                  <option value="{{ get_assembly_record.Assemblies_Code_L3.id }}">{{ get_assembly_record.Assemblies_Code_L3.Assemblies_Code_L3 }}</option>
                                  {% endif %}
                              </select>
                          </div>
                        </div>

                        <div class="row g-2">
                            <div class="col mb-0">
                              <label for="Assembly_Name" class="form-label">Assembly Code</label>
                              <input type="text" id="Assembly_Name" class="form-control" name="Assembly_Name" placeholder="Assembly Code" value="{{get_assembly_record.Assembly_Name}}" required readonly>
                            </div>
                          </div>

                        
                        <div class="row g-2 mt-3">
                          <!-- <div class="col mb-0">
                              <label for="Unit" class="form-label">Unit of Measure</label>
                              <input type="text" id="Unit_of_Measure" name="Unit_of_Measure" class="form-control" placeholder="Unit" value="{{get_assembly_record.Unit_of_Measure}}">
                          </div> -->
                          <div class="col mb-0">
                            <label for="Assembly_Quantity_Show" class="form-label">Assembly<br>Quantity</label>
                            <input type="text" id="Assembly_Quantity_Show" name="Assembly_Quantity_Show" class="form-control" readonly>
                            </div>
                            <div class="col mb-0">
                                <label for="Assembly_Unit_of_Measure_Show" class="form-label">Assembly Unit Of Measure</label>
                                <input type="text" id="Assembly_Unit_of_Measure_Show" name="Assembly_Unit_of_Measure_Show" class="form-control" readonly>
                            </div>
                          <div class="col mb-0">
                            <label for="Assembly_Unit_Cost" class="form-label">Assembly<br>Unit Cost</label>
                            <input type="text" id="Assembly_Unit_Cost" name="Assembly_Unit_Cost" class="form-control" value="" placeholder="Assembly Unit Cost" readonly>
                        </div>
                      </div>
                      <!-- <div class="row g-2 mt-3"> 
                          <div class="col mb-0">
                              <label for="Total_Cost" class="form-label">Total Cost</label>
                              <input type="text" id="Total_Cost" name="Total_Cost" class="form-control" value="100" placeholder="Total Cost" readonly>
                          </div>
                      </div> -->
                        
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                          Close
                        </button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
      
            
          </div>
          <!-- /Account -->
        </div>
       
      </div>
    </div>
  </div>

  <script>
    function Next_Option() {
        // Show the second section
        document.getElementById("second_section_id").style.display = "block";

        // Make assemblyQuantity and Unit_of_Measure readonly
        document.getElementById("assemblyQuantity").readOnly = true;
        document.getElementById("Unit_of_Measure").readOnly = true;
    }
</script>


  <script>
      function modal_open_func() {
        // document.getElementById('Total_Cost').value = document.getElementById('totalCost').innerText;
        document.getElementById('Assembly_Quantity_Show').value = document.getElementById('assemblyQuantity').value;
        document.getElementById('Assembly_Unit_of_Measure_Show').value = document.getElementById('Unit_of_Measure').value;
        document.getElementById('Assembly_Unit_Cost').value = document.getElementById('totalCost').innerText;
        document.getElementById('Quantity').value = 1.00;
      }


      function calculateTotal() {
          var quantity = document.getElementById('Quantity').value;
          var unitCost = document.getElementById('Assembly_Unit_Cost').value;
          var totalCostVar = quantity * unitCost;
          document.getElementById('Assembly_Unit_Cost').value = totalCostVar.toFixed(2);
      }
  </script>



  <script>
    document.addEventListener("DOMContentLoaded", function() {

    calculateTotalCost();
    const AssembliesCodeL1Select = document.getElementById("Assemblies_Code_L1");
    const AssembliesCodeL2Select = document.getElementById("Assemblies_Code_L2");
    const AssembliesCodeL3Select = document.getElementById("Assemblies_Code_L3");
    const AssemblyNameField = document.getElementById("Assembly_Name"); // Add this for the Assembly Name field

    // Initially disable Assemblies_Code_L2 and Assemblies_Code_L3
    AssembliesCodeL2Select.disabled = true;
    AssembliesCodeL3Select.disabled = true;

    AssembliesCodeL1Select.addEventListener("change", function() {
        const AssembliesCodeL1Id = this.value;

        // Reset Assemblies_Code_L2 and L3
        AssembliesCodeL2Select.innerHTML = '<option value="">-- Select --</option>';
        AssembliesCodeL3Select.innerHTML = '<option value="">-- Select --</option>';
        AssembliesCodeL3Select.disabled = true;

        // Update Assembly Name
        updateAssemblyName();

        if (AssembliesCodeL1Id) {
            AssembliesCodeL2Select.disabled = false;

            fetch(`/get-Assemblies-code-l2/?Assemblies_code_l1_id=${AssembliesCodeL1Id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        const option = document.createElement("option");
                        option.value = "";
                        option.text = "No Assemblies Code L2";
                        option.disabled = true;
                        AssembliesCodeL2Select.add(option);
                    } else {
                        data.forEach(item => {
                            const option = document.createElement("option");
                            option.value = item.id;
                            option.text = item.Assemblies_Code_L2;
                            AssembliesCodeL2Select.add(option);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        } else {
            AssembliesCodeL2Select.disabled = true;
            AssembliesCodeL3Select.disabled = true;
        }
    });

    AssembliesCodeL2Select.addEventListener("change", function() {
        const AssembliesCodeL2Id = this.value;

        // Reset Assemblies_Code_L3
        AssembliesCodeL3Select.innerHTML = '<option value="">-- Select --</option>';

        // Update Assembly Name
        updateAssemblyName();

        if (AssembliesCodeL2Id) {
            AssembliesCodeL3Select.disabled = false;

            fetch(`/get-Assemblies-code-l3/?Assemblies_code_l2_id=${AssembliesCodeL2Id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        const option = document.createElement("option");
                        option.value = "";
                        option.text = "No Assemblies Code L3";
                        option.disabled = true;
                        AssembliesCodeL3Select.add(option);
                    } else {
                        data.forEach(item => {
                            const option = document.createElement("option");
                            option.value = item.id;
                            option.text = item.Assemblies_Code_L3;
                            AssembliesCodeL3Select.add(option);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        } else {
            AssembliesCodeL3Select.disabled = true;
        }
    });

    AssembliesCodeL3Select.addEventListener("change", function() {
        // Update Assembly Name
        updateAssemblyName();
    });

    function updateAssemblyName() {

        const level1Text = AssembliesCodeL1Select.options[AssembliesCodeL1Select.selectedIndex]?.text || '';
        const level2Text = AssembliesCodeL2Select.options[AssembliesCodeL2Select.selectedIndex]?.text || '';
        const level3Text = AssembliesCodeL3Select.options[AssembliesCodeL3Select.selectedIndex]?.text || '';

        // Combine the selected values
        const assemblyName = [level1Text, level2Text, level3Text].filter(text => text).join(' - ');

        // Update the Assembly Name field
        if (AssemblyNameField) {
            AssemblyNameField.value = assemblyName;
        }
    }
});

    </script>


  <script>
    let totalCost = 0;

function addItem() {
    const resourceSelect = document.getElementById('numberInput');
    const selectedOption = resourceSelect;
    const resourceName = selectedOption.getAttribute('data-name');
    const unitCost = parseFloat(selectedOption.getAttribute('data-price')) || 0;
    const resourceCodeL1 = selectedOption.getAttribute('data-code-l1');
    const resourceCodeL2 = selectedOption.getAttribute('data-code-l2');
    const resourceCodeL3 = selectedOption.getAttribute('data-code-l3');

    // Get resource details for list_resourses_ids
    const resourceCode_id = selectedOption.getAttribute('data-code-l4');
    const unitOfMeasure = selectedOption.getAttribute('data-unit');
    // Get resource details for list_resourses_ids
    // const quantity = parseFloat(document.getElementById('resourceQuantity').value);

    const resource_quantity_value = parseFloat(document.getElementById('resourceQuantity').value);
    const assembly_quantity_value = parseFloat(document.getElementById('assemblyQuantity').value);

    const quantity = resource_quantity_value / assembly_quantity_value;

    if (!resourceName || isNaN(unitCost) || isNaN(quantity) || quantity <= 0) {
        alert("Please select a resource and enter a valid quantity.");
        return;
    }

    const table = document.getElementById('resourceTable');
    if (table.style.display === 'none') {
        table.style.display = 'table';
    }

    // Get resource details for list_resourses_ids
    const itemTotalCost = unitCost * quantity;

    const tableBody = document.getElementById('resourceTableBody');

    let list_resourses_ids = document.getElementById('list_resourses_ids').value;
    if (list_resourses_ids === "") {
        list_resourses_ids = [];
    } else {
        try {
            list_resourses_ids = JSON.parse(list_resourses_ids);
            if (!Array.isArray(list_resourses_ids)) {
                throw new Error("Input is not an array");
            }
        } catch (e) {
            console.error("Invalid JSON input. Initializing to an empty array.");
            list_resourses_ids = [];
        }
    }

    // Generate a unique identifier for this row
    const uniqueId = String(Date.now());  // Use timestamp as a unique ID

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td  data-code-l4="${resourceCode_id}" data-unique-id="${uniqueId}">${resourceName}</td>
        <td>${resourceCodeL1}</td>
        <td>${resourceCodeL2}</td>
        <td>${resourceCodeL3}</td>
        <td>${resource_quantity_value.toFixed(2)}</td>
        <td>${assembly_quantity_value.toFixed(2)}</td>
        <td>${quantity.toFixed(2)} ${unitOfMeasure}</td>
        <td>$${unitCost.toFixed(2)}</td>
        <td class="row-total">$${itemTotalCost.toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm delete-row" >Delete</button></td>
    `;
    tableBody.appendChild(newRow);

    // Add resource to the list with the unique ID
    list_resourses_ids.push([resourceCode_id, quantity.toFixed(2), itemTotalCost.toFixed(2), uniqueId, "new"]);
    document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

    // Debugging: Verify data-code-l4 is set correctly
    console.log('New Row:', newRow);
    console.log('data-code-l4:', newRow.querySelector('td').getAttribute('data-code-l4'));


    //i am removing this part and this part is also marge
                //newRow.querySelector(".delete-row").addEventListener("click", function () {
                    //newRow.remove(); // Remove the row from the table

                    // Remove the resource from the list
                    //list_resourses_ids = list_resourses_ids.filter(item => item[0] !== resourceCode_id);

                    // Update the hidden input field
                    //document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);


                    //calculateTotalCost(); // Recalculate the total cost dynamically
                //});


    // Add resource to the list
    //list_resourses_ids.push([resourceCode_id, quantity.toFixed(2), itemTotalCost.toFixed(2)]);
    // Update the hidden input field
    //document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

    calculateTotalCost(); // Recalculate the total cost dynamically
    resetForm(); // Reset the form
}

function resetForm() {
    document.getElementById('numberInput').selectedIndex = 0;
    document.getElementById('resourceQuantity').value = 1.0;
}

function calculateTotalCost() {
    let totalCost = 0;
    document.querySelectorAll("#resourceTableBody .row-total").forEach((row) => {
        const rowTotal = parseFloat(row.textContent.replace("$", "")) || 0;
        totalCost += rowTotal;
    });
    document.getElementById('totalCost').innerText = `${totalCost.toFixed(2)}`;
}




//sohel add start


//sohel add end




function show_existing_records() {
    let data = JSON.parse('{{ filter_resources_json|safe }}');
              console.log(data);


              dropdownMenu.innerHTML = ''; // Clear existing items
                  console.log(items.length)
                  console.log('items')
                  if (items.length == 0){
                    dropdownMenu.innerHTML = 'No Resource To Select!';
                  }
                  items.forEach(item => {
                      const li = document.createElement('li');
                      
                      // Display the Resource Code L3 and Unit of Measure in the dropdown
                      const resourceCode = item.Resource_Code_L3__Resource_Code_L3 || `Resource Code L3 ID: ${item.Resource_Code_L3_id}`;
                      const unitOfMeasure = item.Unit_of_Measure || 'No unit'; // Default to 'No unit' if missing

                      // Create the anchor tag for each item
                      const aTag = document.createElement('a');
                      aTag.classList.add('dropdown-item');
                      aTag.href = "#"; // Ensure href is set to a safe value
                      
                      // Set the inner text for the anchor tag
                      aTag.innerHTML = `${resourceCode} (${unitOfMeasure})`;
                      
                      // Add data attributes to the anchor tag
                      aTag.setAttribute('data-name', item.Resource_Title);
                      aTag.setAttribute('data-price', item.Budget_Unit_Cost);
                      aTag.setAttribute('data-code-l1', item.Resource_Code_L1__Resource_Code_L1);
                      aTag.setAttribute('data-code-l2', item.Resource_Code_L2__Resource_Code_L2);
                      aTag.setAttribute('data-code-l3', item.Resource_Code_L3__Resource_Code_L3);
                      aTag.setAttribute('data-unit', item.Unit_of_Measure);

                      // Add the click event listener for the anchor tag
                      aTag.addEventListener('click', (e) => {
                          e.preventDefault(); // Prevent the default anchor behavior
                          
                          // Set the input field values based on the selected item
                          numberInput.value = item.Resource_Code_L3__Resource_Code_L3; // Assuming you want to use item.id for input value

                          // Optionally, you can also set data attributes on numberInput if needed
                          numberInput.setAttribute('data-name', item.Resource_Title);
                          numberInput.setAttribute('data-price', item.Budget_Unit_Cost);
                          numberInput.setAttribute('data-code-l1', item.Resource_Code_L1__Resource_Code_L1);
                          numberInput.setAttribute('data-code-l2', item.Resource_Code_L2__Resource_Code_L2);
                          numberInput.setAttribute('data-code-l3', item.Resource_Code_L3__Resource_Code_L3);
                          numberInput.setAttribute('data-code-l4', item.id);
                          numberInput.setAttribute('data-unit', item.Unit_of_Measure);

                          // Hide the dropdown and redirect (if needed)
                          dropdownMenu.classList.remove('show');
                          // window.location.href = ``; // Redirect to the new page
                      });

                      // Append the anchor tag to the list item and the list item to the dropdown menu
                      li.appendChild(aTag);
                      dropdownMenu.appendChild(li);
                  });


    // Get selected resource and quantity
    const resourceSelect = document.getElementById('numberInput');
    // const selectedOption = resourceSelect.options[resourceSelect.selectedIndex];
    const selectedOption = resourceSelect;
    const resourceName = selectedOption.getAttribute('data-name');
    const unitCost = parseFloat(selectedOption.getAttribute('data-price')) || 0;
    const resourceCodeL1 = selectedOption.getAttribute('data-code-l1');
    const resourceCodeL2 = selectedOption.getAttribute('data-code-l2');
    const resourceCodeL3 = selectedOption.getAttribute('data-code-l3');
    const resourceCode_id = selectedOption.getAttribute('data-code-l4');
    const unitOfMeasure = selectedOption.getAttribute('data-unit');
    const resource_quantity_value = parseFloat(document.getElementById('resourceQuantity').value);
    const assembly_quantity_value = parseFloat(document.getElementById('assemblyQuantity').value);

    const quantity = resource_quantity_value / assembly_quantity_value;

    if (!resourceName || isNaN(unitCost) || isNaN(quantity) || quantity <= 0) {
        alert("Please select a resource and enter a valid quantity.");
        return;
    }

    // Show the table if it's hidden
    const table = document.getElementById('resourceTable');
    if (table.style.display === 'none') {
        table.style.display = 'table';
    }

    // Calculate the total cost for this item
    const itemTotalCost = unitCost * quantity;

    // Add a new row to the table
    const tableBody = document.getElementById('resourceTableBody');



    let list_resourses_ids = document.getElementById('list_resourses_ids').value;
    // Check if the input value is empty
    if (list_resourses_ids === "") {
        list_resourses_ids = [];
    } else {
            try {
                // Try to parse the input value as JSON
                list_resourses_ids = JSON.parse(list_resourses_ids);
                if (!Array.isArray(list_resourses_ids)) {
                    throw new Error("Input is not an array");
                }
            } catch (e) {
                console.error("Invalid JSON input. Initializing to an empty array.");
                list_resourses_ids = [];
            }
        }


    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>${resourceName}</td>
        <td>${resourceCodeL1}</td>
        <td>${resourceCodeL2}</td>
        <td>${resourceCodeL3}</td>
        <td>${resource_quantity_value.toFixed(2)}</td>
        <td>${assembly_quantity_value.toFixed(2)}</td>
        <td>${quantity.toFixed(2)} ${unitOfMeasure}</td>
        <td>$${unitCost.toFixed(2)}</td>
        <td class="row-total">$${itemTotalCost.toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm delete-row">Delete</button></td>
    `;
    tableBody.appendChild(newRow);

    console.log(resourceCode_id)
    console.log('resourceCode_id')



    // Update the overall total cost
    //totalCost += itemTotalCost;
    //document.getElementById('totalCost').innerText = `${totalCost.toFixed(2)}`;

    resource_quantity = [resourceCode_id, quantity.toFixed(2), totalCost.toFixed(2), unitOfMeasure, resource_quantity_value.toFixed(2), assembly_quantity_value.toFixed(2)]
    // Example of appending an item to the list
    list_resourses_ids.push(resource_quantity);
    // Store the array back to the input as a JSON string
    document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);


    // Reset the form for the next entry
    //resourceSelect.selectedIndex = 0;
    //document.getElementById('resourceQuantity').value = 1.0;

    document.getElementById('div_save_button').style.display = 'block';
}

  </script>



  <script>


document.addEventListener('click', function (event) {
    if (event.target.classList.contains('delete-row')) {
        const button = event.target;
        const row = button.closest('tr');
        const resourceId = button.getAttribute('data-id'); // For existing rows
        console.log("resourceId")
        console.log(resourceId)
        const resourceCode_id = row.querySelector('td').getAttribute('data-code-l4'); // Resource ID
        const uniqueId = row.querySelector('td').getAttribute('data-unique-id'); // Unique ID

        console.log('Resource ID:', resourceCode_id);
        console.log('Unique ID:', uniqueId);

        // Get the list of resources
        let list_resourses_ids = JSON.parse(document.getElementById('list_resourses_ids').value || '[]');

        if (resourceId) {
            // Handle existing rows with data-id (rows already saved in the database)
            if (confirm("Are you sure you want to delete this item?")) {
                fetch('/delete-resource/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // For Django CSRF protection
                    },
                    body: JSON.stringify({ resource_id: resourceId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from the table
                        row.remove();


                        // Update the total cost
                        const itemTotalCost = parseFloat(row.children[6].innerText.replace('$', ''));
                        totalCost -= itemTotalCost;
                        document.getElementById('totalCost').innerText = `${totalCost.toFixed(2)}`;

                        // Remove the resource from the list using the unique ID
                        list_resourses_ids = list_resourses_ids.filter(item => item[3] !== uniqueId);

                        // Update the hidden input field
                        document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

                        // Recalculate the total cost
                        calculateTotalCost();

                        alert("Item deleted successfully!");
                    } else {
                        alert("Failed to delete item: " + data.error);
                    }
                })
                .catch(error => {
                    console.error("Error deleting resource:", error);
                    alert("An error occurred while deleting the item.");
                });
            }
        } else {
            // Handle dynamically added rows (rows not yet saved in the database)
            row.remove();

            // Remove the resource from the list using the unique ID
            list_resourses_ids = list_resourses_ids.filter(item => item[3] !== uniqueId);

            // Update the hidden input field
            document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

            // Recalculate the total cost
            calculateTotalCost();
            alert("Item deleted successfully!");
        }
    }
});





    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

  </script>



  <script>

      document.addEventListener("DOMContentLoaded", function () {
          // Check if get_assembly_record has a value
          const getAssemblyRecord = "{{ get_assembly_record }}"; // Pass the value from Django to JavaScript
          if (getAssemblyRecord && getAssemblyRecord !== "None") {
            console.log("get_assembly_record has a value:", getAssemblyRecord);


            const AssembliesCodeL2Select = document.getElementById("Assemblies_Code_L2");
            const AssembliesCodeL3Select = document.getElementById("Assemblies_Code_L3");
            //const AssemblyNameField = document.getElementById("Assembly_Name"); // Add this for the Assembly Name field

            // Initially disable Assemblies_Code_L2 and Assemblies_Code_L3
            AssembliesCodeL2Select.disabled = false;
            AssembliesCodeL3Select.disabled = false;

            updateAssemblyName();




            //and for add the list start

            //and for add the list end



          } else {
            console.log("get_assembly_record has no value.");
          }
        });

  </script>


  <script>
      document.addEventListener("DOMContentLoaded", function () {
  // Initialize list_resourses_ids with existing resources
  let list_resourses_ids = [];


  // Loop through existing resources and add them to the list
  {% for exist_resource in filter_Estimation_Assemblies_Resource_Details %}
    list_resourses_ids.push([
      "{{ exist_resource.Resource_record.id }}", // Resource ID
      "{{ exist_resource.Quantity }}", // Quantity
      "{{ exist_resource.Unit_Cost }}" // Total Cost
    ]);
  {% endfor %}

  // Update the hidden input field
  document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

  // Log the initial list_resourses_ids for debugging
  console.log("Initial list_resourses_ids:", list_resourses_ids);






});

  </script>

  <script>

document.addEventListener("DOMContentLoaded", function () {
    // Parse the list_resourses_ids from the hidden input field
    let list_resourses_ids = JSON.parse(document.getElementById('list_resourses_ids').value || '[]');

    // Add data-code-l4 and data-unique-id to existing rows
    const existingRows = document.querySelectorAll("#resourceTableBody tr");
    existingRows.forEach((row, index) => {
        const firstTd = row.querySelector("td");
        const deleteButton = row.querySelector(".delete-row");
        if (firstTd && list_resourses_ids[index]) {
            // Get the resource ID and unique ID (use the saved item's ID from the database)
            const resourceId = list_resourses_ids[index][0];
            const uniqueId = deleteButton.getAttribute('data-id'); // Use the saved item's ID as the unique ID

            // Set the data-code-l4 and data-unique-id attributes
            firstTd.setAttribute("data-code-l4", resourceId);
            firstTd.setAttribute("data-unique-id", uniqueId);

            // Update the list_resourses_ids array with the unique ID
            //list_resourses_ids[index].push(uniqueId);
            list_resourses_ids[index].push(uniqueId, "existing");
        }
    });

    // Update the hidden input field with the modified list_resourses_ids
    document.getElementById('list_resourses_ids').value = JSON.stringify(list_resourses_ids);

    console.log("Updated list_resourses_ids:", list_resourses_ids);
});


  </script>

{% endblock %}

